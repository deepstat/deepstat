---
title: "'ggmap'을 이용해서 대구 메트로 시각화하기 - 2일차"
output:
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 함께 보기

- 'ggmap'을 이용해서 대구 메트로 시각화하기 - 1일차
    - https://deepstat.tistory.com/96


# 목적

- 대구 메트로 상하차 정보가 인터넷에 공개되어있는데, 이를 기반으로 지도에 시각화해보면, 어떤 통찰(인사이트)를 얻을 수 있지 않을까 하는 생각이 들어서 해보게 되었다.

- 메트로, 시내버스, 택시정보 등등을 하나하나 시각화하고 이를 종합할 수 있다면, 대구 교통량이 어떤지 뿐만 아니라, 더 나아가서,
    - 대구 대중교통체계가 잘 작동하고 있는지,
    - 어떤 곳이 교통 취약지역인지,
    - 어떤 곳이 교통이 좋은지,
    - 어떻게 보강하는게 좋을 것인지
    등을 고민할 수 있는 여지가 생긴다고 생각한다.

- 혹은 부동산?

- 혹은 정책평가?

# 필요한 패키지

- `tidyverse`, `reshape2`, `ggmap`

```{r}
library(tidyverse)
library(reshape2)
library(ggmap)
```

# 데이터

## 전국도시철도역사정보표준데이터.csv ("df_역"이라 명명)

- 출처 : https://www.data.go.kr/dataset/15013205/standard.do

```{r}
df_역 <- read.csv("../Original_Data/전국도시철도역사정보표준데이터.csv", fileEncoding = "CP949")
```

## 대구도시철도공사_일별시간별승하차인원_20171231.csv ("df_승하차인원"이라 명명)

- 출처 : https://www.data.go.kr/dataset/15002503/fileData.do

```{r}
df_승하차인원 <- read.csv("../Original_Data/대구도시철도공사_일별시간별승하차인원_20171231.csv", fileEncoding = "CP949")
```

# 데이터 전처리

## df_역에서 대구 메트로 정보만 가져오기.

```{r}
df_대구메트로역 <- df_역 %>%
  select(., 노선명, 역번호, 역사명, 역위도, 역경도) %>% # 남길 열 선택
  filter(., substr(노선명,1,2) == "대구") %>% # $노선명 의 앞 2자리가 대구면 선택한다.
  mutate(., 노선명 = substr(노선명,9,11)) # 노선명을 정리
```

### 대구 지도에 지하철역 뿌려보기

- 대구 지도 가져오기

```{r}
대구지도 <- get_map(c(lon=128.60250, lat=35.87222), zoom=12, maptype="toner-lite")
```

- 1호선만

```{r}
ggmap(대구지도) + geom_point(data=df_대구메트로역 %>% filter(노선명 == "1호선"), aes(역경도, 역위도, colour = 노선명))
```

- 1호선 자료가 좀 이상한 것 같다. `명덕역`, `대구역`과 `칠성시장역` 언뜻 보기에 왼쪽으로 약간 shift 된 것 같다.

- 2호선만

```{r}
ggmap(대구지도) + geom_point(data=df_대구메트로역 %>% filter(노선명 == "2호선"), aes(역경도, 역위도, colour = 노선명))
```

- 3호선만

```{r}
ggmap(대구지도) + geom_point(data=df_대구메트로역 %>% filter(노선명 == "3호선"), aes(역경도, 역위도, colour = 노선명))
```

## df_승차자인원을 조금 더 다루기 쉬운 형태로 정리하기.

```{r}
df_승하차_melted <- df_승하차인원 %>%
  select(., -일계) %>% # 1. $일계 제거
  melt(.,id.vars = c("월", "일", "역번호", "역명", "승하"),
       variable.name = "시간", value.name = "인원") %>% # 2. melt 사용
  mutate(., 시간 = paste(substr(시간,2,3), "-", substr(시간,5,6), sep="")) %>% # 3. 시간 바로잡기
  mutate(., 역번호 = paste(substr(역번호, 1, 3))) # 4. 역번호 뒤에 0 떼기
```

## 가공한 데이터 2개 (`df_대구메트로역`, `df_승하차_melted`)를 합치자.

- `$역번호`를 기준으로 join 할 거다.

```{r}
df_merged <- merge(x = df_승하차_melted, y = df_대구메트로역, by = "역번호", all.x = TRUE) %>%
  select(., -역사명) # $역명 과 $역사명 이 중복이라서 제거.
```

## 환승역 합치기

### 합치기 전에 살펴보기

```{r}
levels(df_merged$역명)
```

- 역명에 뒤에 숫자가 붙은 것들이 환승역이고, `명덕1`은 `1호선 명덕역`, `명덕3`는 `3호선 명덕역` 등등이다.

#### 명덕역

```{r}
df_merged %>% filter(역명 %in% c("명덕1","명덕3")) %>% filter(월 == 1, 일 == 1, 시간 == "06-07")
```

- 지도로 찍었을 때, `명덕1`의 위치가 왼쪽으로 shift 돼있음을 볼 수 있었기 때문에 명덕3의 위치를 사용하고자 한다.

- 환승역의 노선명은 일괄적으로 `"환승"`으로 바꾸고자 한다.

```{r}
df_명덕역 <- df_merged %>%
  filter(., 역명 %in% c("명덕1","명덕3")) %>% # 명덕역만 골라오기
  mutate(., 노선명 = "환승") %>% # 노선명을 "환승"으로
  mutate(., 역번호 = "331") %>% # 역번호를 331로
  mutate(., 역위도 = 35.85698) %>% # 역위도를 35.85698로
  mutate(., 역경도 = 128.5900) %>% # 역경도를 128.5900으로
  mutate(., 역명 = "명덕") %>% # 역명을 "명덕"으로
  group_by(., 역번호, 월, 일, 역명, 승하, 시간, 노선명, 역위도, 역경도) %>%
  summarize(.,인원 = sum(인원))

df_명덕역 %>% head(.)
df_명덕역 %>% tail(.)
```

### 반월당역

```{r}
df_merged %>% filter(역명 %in% c("반월당1","반월당2")) %>% filter(월 == 1, 일 == 1, 시간 == "06-07")
```

- 반월당역은 반월당2의 위치를 사용하고,

```{r}
df_반월당역 <- df_merged %>%
  filter(., 역명 %in% c("반월당1","반월당2")) %>% # 반월당역만 골라오기
  mutate(., 노선명 = "환승") %>% # 노선명을 "환승"으로
  mutate(., 역번호 = "230") %>% # 역번호를 230으로
  mutate(., 역위도 = 35.86551) %>% # 역위도를 35.86551로
  mutate(., 역경도 = 128.5934) %>% # 역경도를 128.5934으로
  mutate(., 역명 = "반월당") %>% # 역명을 "반월당"으로
  group_by(., 역번호, 월, 일, 역명, 승하, 시간, 노선명, 역위도, 역경도) %>%
  summarize(.,인원 = sum(인원))

df_반월당역 %>% head(.)
df_반월당역 %>% tail(.)
```

### 신남역

```{r}
df_merged %>% filter(역명 %in% c("신남2","신남3")) %>% filter(월 == 1, 일 == 1, 시간 == "06-07")
```

- 신남역은 신남3의 위치를 사용하고자 한다.

```{r}
df_신남역 <- df_merged %>%
  filter(., 역명 %in% c("신남2","신남3")) %>% # 신남역만 골라오기
  mutate(., 노선명 = "환승") %>% # 노선명을 "환승"으로
  mutate(., 역번호 = "329") %>% # 역번호를 329으로
  mutate(., 역위도 = 35.86427) %>% # 역위도를 35.86427로
  mutate(., 역경도 = 128.5823) %>% # 역경도를 128.5823으로
  mutate(., 역명 = "신남") %>% # 역명을 "신남"으로
  group_by(., 역번호, 월, 일, 역명, 승하, 시간, 노선명, 역위도, 역경도) %>%
  summarize(.,인원 = sum(인원))

df_신남역 %>% head(.)
df_신남역 %>% tail(.)
```

### 다시 합치기

```{r}
df_merged_2 <- df_merged %>%
  filter(.,!(역명 %in% c("명덕1","명덕3","반월당1","반월당2","신남2","신남3"))) %>%
  bind_rows(.,df_명덕역) %>%
  bind_rows(.,df_반월당역) %>%
  bind_rows(.,df_신남역)

unique(df_merged_2$역명)
```

# 지도에 뿌리기

## 2017년 12월 24일 오후 6시에서 7시 이용현황 (다시 그리기)

- 데이터 전처리
    - `$월` == 12 , `$일` == 25 , `$시간` == 18-19 만 가져와야함.

```{r}
temp_df <- df_merged_2 %>%
  filter(., (월 == 12) & 일 == 25 & 시간 == "18-19")
```

- 승차인원만.

```{r}
ggmap(대구지도) + geom_point(data=temp_df %>% filter(., 승하 == "승차") , aes(역경도, 역위도, colour = 노선명, size = 인원), alpha = 0.6)
```

- 하차인원만.

```{r}
ggmap(대구지도) + geom_point(data=temp_df %>% filter(., 승하 == "하차") , aes(역경도, 역위도, colour = 노선명, size = 인원), alpha = 0.6)
```

- 둘 다 한꺼번에.

```{r}
ggmap(대구지도) + geom_point(data=temp_df , aes(역경도, 역위도, colour = 노선명, size = 인원), alpha = 0.6) + facet_grid(.~승하)

```

## 2017년 요일별 이용현황

- 요일 변수를 만들어야 한다.

```{r}
library(stringr)
df_merged_2 <- df_merged_2 %>%
  mutate(요일 = paste("2017",
    "-",str_sub(paste("0",as.character(월),sep=""),-2,-1),
    "-",str_sub(paste("0",as.character(일),sep=""),-2,-1),
    sep="") %>% as.Date(.) %>% weekdays(.) %>% factor(.,levels =c("월요일","화요일","수요일","목요일","금요일","토요일","일요일"))
  )
head(df_merged_2)
```

- 요일변수를 기준으로 인원의 평균을 구하려한다.

- 하루동안 승차자와 하차자는 매우매우 비슷해서 그렸을 때 눈으로 구별되지 않기 때문에 구태여 구분하지 않았다.

```{r}
df_sum_요일 <- df_merged_2 %>%
  group_by(., 역명, 노선명, 역위도, 역경도, 요일) %>%
  summarize(인원 = sum(인원))

dim(df_sum_요일)
head(df_sum_요일)
```

- 지도에 뿌려보자.

```{r, fig.height=35}
ggmap(대구지도) + geom_point(data=df_sum_요일 , aes(역경도, 역위도, size = 인원), alpha = 0.7) + facet_grid(요일~.)
```

- 평일 출퇴근하는 사람들 때문에 더 많이 이용하지 않을까 했지만, 큰 차이가 없어보인다.

## 2017년 시간대별 이용현황 (아침, 점심, 저녁)

- 시간대 변수를 만들어야 한다.
    - 아침 :      ~ 12시
    - 점심 : 12시 ~ 18시
    - 저녁 : 18시 ~ 

```{r}
library(stringr)
df_merged_2 <- df_merged_2 %>%
  mutate(., 시간대 = ifelse(
    시간 %in% c("06-07","07-08","09-10","10-11","11-12"),
    "아침", ifelse(
      시간 %in% c("12-13","13-14","14-15","15-16","16-17","17-18"),
      "점심","저녁")) %>%
    factor(.,levels =c("아침","점심","저녁"))
  )
head(df_merged_2)
```

- 시간대 변수를 기준으로 인원의 평균을 구하려한다.

```{r}
df_sum_시간대 <- df_merged_2 %>%
  group_by(., 역명, 승하, 노선명, 역위도, 역경도, 시간대) %>%
  summarize(인원 = sum(인원))

dim(df_sum_시간대)
head(df_sum_시간대)
```

- 지도에 뿌려보자.

```{r, fig.height=15}
ggmap(대구지도) + geom_point(data=df_sum_시간대 , aes(역경도, 역위도, colour = 승하, size = 인원), alpha = 0.6) + facet_grid(시간대~.)
```

- 아침과 점심에는 시내로의 유입이 더 많고, 저녁에는 유출이 더 많다. (파란 원이 더 크면 유입, 붉은 원이 더 크면 유출. 생각보다 시각적으로 잘 안 보인다.)

# 정리, 반성 및 Future work

- 생각보다 어떤 현상이 시각적으로 잘 드러나지 않아서 그 부분이 아쉬웠다. (다른 방법으로의 시각화가 더 필요한 듯 보인다. 어떤 방법들이 가능할까?)

- 단순하게 의사결정나무나 회귀분석이라도 적용해서 수치를 보는 것도 나쁘지 않을 듯 하다. 요일별로 차이가 있는지, 혹은 시간대별로 차이가 있는지 알아볼 수 있는 강력한 도구 중 하나가 아닐까?

- 역이 너무 조밀하게 있어서 구/군별로 나눠서 표시하는 것이 나을지도 모른다는 생각이 든다.  구/군별로 그 크기가 너무 많이 다르기 때문에 그려봐야만 옳은지 그른지 판단할 수 있는 문제일지도 모른다. (구/군에 대한 공간정보를 포함한 새로운 데이터가 필요하다.)

- shinyR을 쓰면 상호작용하는 앱을 만들수도 있겠다.

- ggplotly를 쓰면 시각적으로 더 멋있는 결과를 얻을지도 모르겠다. 공부해야봐야겠다.
